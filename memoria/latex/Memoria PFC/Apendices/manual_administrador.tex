
\chapter{Manual de administrador}

En esta sección vamos a explicar como un administrador puede instalar
la aplicación y ponerla en marcha 


\section{Consideraciones}

Aunque este manual intenta ser autoexplicativo en cuanto a la instalación
de la plataforma, no es un manual de las distintas herramientas usadas
en la plataforma, por lo que para ello se remite a la documentación
oficial de estas. Por otra parte se espera que el administrador de
la aplicación tenga nociones en la administración de servidores web,
así como unas nociones muy básicas de Python.


\section{Requisitos hardware}

Los requisitos hardware dependerán del número de usuarios que van
a acceder a la plataforma.

Si se quiere medir como se comporta la plataforma ante un número elevado
de usuarios, en la carpeta jmeter se incluye una configuración para
Apache JMeter, así como un generador de usuarios y una encuesta compleja.
Esta aplicación genera todas los peticiones que realizaría un usuario
al contestar a una encuesta. Para ejecutar la plataforma en este modo,
debe cambiar la variable de entorno \emph{FLASK\_CONFIG} a \emph{jmeterProduction}
o en el fichero \emph{config.py} cambiar la configuración default
por \emph{jmeterProduction.}\begin{figure}[!tbh]
 	\begin{center}
\begin{listing}[style=consola, numbers=none]
config = {     
	'development': DevelopmentConfig,
    'testing': TestingConfig,
	'production': ProductionConfig,
	'heroku': HerokuConfig,
    'unix': UnixConfig,
    'jmeter': Jmeter,
    'jmeterProduction' : JmeterProduction,

    'default': DevelopmentConfig }
\end{listing}
		 \caption{Parte del fichero config.py}
 		\label{fig:config.py}
	 \end{center}
\end{figure}
También existe la posibilidad de ejecutar la plataforma en la nube.
Dependiendo de la elección llevará mas o menos cambio. En el anexo
{*}{*}Guía de desarrollo{*}{*} se incluyen las modificaciones y los
pasos necesarios para ejecutar la aplicación en Heroku.


\section{Requisitos software}

Los requistos software son los siguientes:
\begin{itemize}
\item Virtualenv: Para la creación de un entorno virtual de Python para
la instalación de todas los módulos necesarios.
\item Git: Para poder descargarse la aplicación.
\item Servidor web compatible con WSGI, en la documentación de Flask puedes
encontrar una guía rápida para la puesta en marcha del servidor, http://flask.pocoo.org/docs/deploying/ 
\item Base de datos a usar, está debe ser compatible con SQLAlchemy, las
posibilidades son las siguientes: {*} 

\begin{itemize}
\item Postgresql
\item MySQL y su fork MariaDB 
\item Oracle {*} Microsoft SQL Server
\item SQLite 
\end{itemize}
\end{itemize}

\section{Instalación}

Empezaremos clonando el repositorio git donde se encuentra la aplicación:\begin{listing}[style=consola, numbers=none]
$ git clone git://github.com/nu_kru/swarm-survey.git
$ cd swarm-survey
\end{listing}Una vez clonado el repositorio procederemos a crear un entorno virtual
para poder instalar todas las dependencias necesarias en la aplicación:

\begin{listing}[style=consola, numbers=none]
$ mkdir swarm-surveys
$ virtualenv venv
New python executable in venv/bin/python
Installing distribute............done.
\end{listing}Una vez instalado el entorno virtual, para activarlo: 

\begin{listing}[style=consola, numbers=none]
$ . venv/bin/activate 
\end{listing}Una vez dentro del entorno virtual procederemos a instalar todas las
dependencias de la aplición. Todas ellas, así como la versión usada
se encuentran en el fichero \emph{requeriments.txt}. Para instalarla
haremos uso de pip, el cual se ha instalado dentro de \emph{virtualenv}:

\begin{listing}[style=consola, numbers=none]
(venv)$ pip install -r requeriments.txt 
\end{listing}

Con esto ya tendremos instalada la aplicación así como todos los módulos
necesarios para hacerla funcionar.


\section{Configuración}

La configuración de la plataforma está localizada en los ficheros
escritos en Python, \emph{config.py }y \emph{settings}.

En el fichero config.py se puede observar los distintos modos en los
que se puede arrancar la aplicación, estos son los siguientes:
\begin{itemize}
\item \textbf{Development}: para el desarrollo de la plataforma.
\item \textbf{Testing}: para ejecutar los test unitarios de la plataforma.
\item \textbf{Production}: configuración base para el modo producción
\item \textbf{Heroku}: para ejecutar la aplicación en modo producción en
la nube Heroku.
\item \textbf{Unix}: para ejecutar la aplicación en modo producción en una
máquina de tipo Unix
\item \textbf{Jmeter}: para ejecutar el test de sobrecargar y aceptación
\item \textbf{JmeterProduction}: para ejecutar el test de sobrecarga y aceptación
en una máquina en modo producción.
\end{itemize}
Para cambiar de modo, puede hacerlo mediante la variable de entorno
\emph{CONFIG\_FLASK} o sino está definida modificando la configuración
por defecto en el fichero \emph{config.py}.

En el fichero \emph{settings} se encuentra una plantilla con las variables
a cambiar. La plataforma espera encontrar la localización del fichero
usando la variable de entorno \emph{SWARMS\_SURVEY\_SETTINGS} o sino
por defecto el fichero \emph{settings.cfg} el cual se genera automáticamente
si no se encuentra.

Tanto el fichero \emph{settings }como \emph{config.py} son autoexplicativos,
estando documentado el significado de cada opción. En el fichero \emph{settings
}básicamente hay que indicar cual es el servidor de correo y los usuarios
a los cuales se le va a enviar los correos con las distintas alertas
que puede generar la plataforma, así como el usuario administrador
y la contraseña de este.


\section{Base de datos}


\subsection{Configuración de la base de datos a usar}

La plataforma hace uso de la variable de entorno {*}{*}DEV\_DATABASE\_URL{*}{*}
en la cual espera que se encuentre la URI de la conexión de la base
de datos, así como el usuario y contraseña. Si la variable no está
definida usa por defecto SQLite.

El formato es el siguiente: 

\begin{listing}[style=consola, numbers=none]
driver://username:password@host:port/database 
\end{listing}Por ejemplo para MySQL:

\begin{listing}[style=consola, numbers=none]
driver://username:password@host:port/database 
\end{listing}

Mas información para la configuración de la base de datos consulte
la documentación oficial de SQLAlchemy:

http://docs.sqlalchemy.org/en/rel\_0\_9/core/engines.html 


\subsection{Creación de la base de datos}

Una vez definida la base de datos a usar entre las soportadas por
SQLALchemy, debemos de crear la base de datos, para ello ejecutaremos
los siguientes comandos:

\begin{listing}[style=consola, numbers=none]
(venv)$./manage.py db init 
(venv)$./manage.py db migrate 
(venv)$./manage.py db upgrade
\end{listing}Con esto generamos la base de datos, además se hace uso de \emph{flask-migrate},
una extensión que hace uso de \emph{Alembic} para poder migrar la
base de datos a nuevas actualizaciones del sistema. Para obtener mas
información de como migrar o volver a una revisión anterior de la
base de datos, consulte la documentación oficial: http://flask-migrate.readthedocs.org/en/latest/


\section{Inicio del programa}

Dependiendo del servidor web usado, deberá arrancar la aplicación
de una manera u otra, para ello diríjase a la documentación oficial
de su servidor web o consulte como guía rápida, http://flask.pocoo.org/docs/deploying/

\begin{figure}[!tbh]
 	\begin{center}
\begin{listing}[style=consola, numbers=none]
#Usando el servidor Gunicorn:
(venv)$ gunicorn manage.py runserver:app
#Usando el servidor de desarrollo de Flask:
(venv)$ manage.py runserver
\end{listing}
		 \caption{Modos de inicializar el programa}
 		\label{fig:inicio_programa}
	 \end{center}
\end{figure}


Una vez puesta en marcha la plataforma, se crea automáticamente en
la base de datos el usuario administrador indicado en el fichero de
configuración, además también se le otorgan roles de investigador
para poder crear encuestas.


\section{Asignación del rol investigador a un usuario}

Para asignar el rol de investigador a un usuario, inicie la shell
del programa. Esto abrirá un interprete Python de la plataforma web.
Entre las funciones disponibles están la de \emph{add\_researcher}
y \emph{delete\_researcher}, que sirven para dar y quitar permisos
de investigador a un usuario dado. En la Figura \ref{fig:comandos_shell},
hay una muestra de comandos disponibles.

\begin{figure}[!tbh]
 	\begin{center}
\begin{listing}[style=consola, numbers=none]
#Inicio de la shell:
(venv)$ manage.py shell
#Dar permisos de investigador al usuario foo@foo.com:
>>>add_researcher(foo@foo.com)
#Quitar permisos de investigador al usuario foo@foo.com
>>>delete_researcher(foo@foo.com)
#Listar usuarios disponibles:
>>>list_user()
\end{listing}
		 \caption{Ejemplos de comandos disponibles en la shell}
 		\label{fig:comandos_shell}
	 \end{center}
\end{figure}


\section{Actualización}

Antes de actualizar la plataforma se recomienda hacer una copia de
seguridad de la base de datos y del entorno virtualizado donde se
ha instalado la plataforma. Los pasos para actualizar son los siguientes:
\begin{itemize}
\item Haga una copia de la configuración de la plataforma, \emph{config.py}
y \emph{settings.cfg.}
\item Descargue la última versión de la plataforma mediante git:
\end{itemize}
\begin{listing}[style=consola, numbers=none]
(venv)$ git pull 
\end{listing}
\begin{itemize}
\item Instale los nuevos módulos requeridos: 
\end{itemize}
\begin{listing}[style=consola, numbers=none]
(venv)$pip install -r requeriments.txt 
\end{listing}
\begin{itemize}
\item Compruebe si ha habido algún cambio en los ficheros de configuración.
\item Actualice la base de datos si es necesario:
\end{itemize}
\begin{listing}[style=consola, numbers=none]
(venv)$./manage.py db migrate 
(venv)$./manage.py db upgrade
\end{listing}


\section{Log}

La plataforma por defecto guarda todos los mensajes con un nivel \emph{warning}
o superior en el fichero \emph{temp/swarms.log }esta configuración
se puede cambiar en el fichero config.py, también se puede elegir
usar \emph{SysLogHandler} para comunicarse remotamente con una maquina
Unix, quién almacenará la información.

Además tambien se enviará por correo al usuario indicado los mensajes
con un nivel \emph{error} o superior.

El nivel de los mensajes se puede cambiar, los disponibles son los
siguientes: 
\begin{itemize}
\item critical.
\item error.
\item warning.
\item info.
\item debug.
\end{itemize}
Mas información disponible en https://docs.python.org/2/library/logging.html
